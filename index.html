<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Calcolo Portate Aria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="rounded_icon_180.png">

  <style>
    :root {
      --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      --bg: #020617;
      --bg-elevated: #0b1120;
      --card-soft: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.18);
      --border: #1e293b;
      --border-soft: #0f172a;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
    }

    html[data-theme="light"] {
      --bg: #f3f4f6;
      --bg-elevated: #ffffff;
      --card-soft: #ffffff;
      --accent: #16a34a;
      --accent-soft: rgba(22,163,74,0.18);
      --border: #cbd5e1;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
      font-family: var(--font-main);
      padding: 12px;
      display: flex;
      justify-content: center;
    }

    .app { width: 100%; max-width: 520px; }

    header {
      background: var(--bg-elevated);
      padding: 6px 10px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      border: 1px solid var(--border-soft);
    }

    .app-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 10px;
    }

    .app-title {
      font-size: 18px;
      font-weight: 700;
    }

    .app-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .card {
      background: var(--card-soft);
      padding: 14px;
      border-radius: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
    }

    input, select {
      width: 100%;
      height: 48px !important;
      font-size: 16px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-main);
      margin-bottom: 8px;
      box-sizing: border-box;
    }

    .btn-primary {
      width: 100%;
      padding: 11px;
      border-radius: 12px;
      background: var(--accent);
      font-weight: 700;
      border: none;
    }

    .twoLine {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .label { font-size: 13px; color: var(--text-muted); }
    .value { font-size: 16px; font-weight: 700; white-space: nowrap; }

    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      margin-left: 4px;
    }
    .tag-ok { background: #22c55e33; color: #22c55e; }
    .tag-low { background: #3b82f630; color: #3b82f6; }
    .tag-high { background: #f9731630; color: #fb923c; }
    .tag-na { background: #6b728033; color: #6b7280; }
  </style>

</head>

<body>
<div class="app">

<header>
  <img src="logo.png" class="app-logo">
  <div>
    <div class="app-title">Calcolo Portate Aria</div>
    <div class="app-subtitle">Air Distribution Systems</div>
  </div>
</header>

<div class="card">
  <h2>Input</h2>

  <label>Portata Q (m³/h)</label>
  <input id="flow" type="number" inputmode="decimal">

  <label>Velocità V (m/s)</label>
  <input id="velocity" type="number" inputmode="decimal">

  <label>Tipo ambiente (UNI 10339 / 16798)</label>
  <select id="scenario">
    <option value="res">Residenziale</option>
    <option value="office">Uffici</option>
    <option value="hospital">Area sanitaria</option>
    <option value="extract">Estrazione aria</option>
    <option value="main">Montante</option>
    <option value="none">Nessun limite</option>
  </select>

  <label>Forma canale</label>
  <select id="geom">
    <option value="rect">Rettangolare</option>
    <option value="circ">Circolare</option>
  </select>

  <div id="rect_fields">
    <label>Base (mm)</label>
    <input id="base" type="number" inputmode="decimal">

    <label>Altezza (mm)</label>
    <input id="height" type="number" inputmode="decimal">
  </div>

  <div id="circ_fields" style="display:none;">
    <label>Diametro (mm)</label>
    <input id="diam" type="number" inputmode="decimal">
  </div>

  <button class="btn-primary" onclick="calcola()">Calcola</button>
</div>

<div class="card" id="results">
  <h2>Risultati</h2>

  <div class="twoLine">
    <span class="label">Area A</span>
    <span class="value" id="areaOut">—</span>
  </div>

  <div class="twoLine">
    <span class="label">Velocità</span>
    <span class="value"><span id="vEffOut">—</span> <span id="vEffTag" class="tag tag-na">n/d</span></span>
  </div>

  <div id="rectOnly">
    <div class="twoLine">
      <span class="label">Diametro equivalente (Ø)</span>
      <span class="value" id="stdDNOut">—</span>
    </div>
  </div>

  <div id="circOut" style="display:none;">

    <div class="twoLine">
      <span class="label">Lato sezione quadrata</span>
      <span class="value" id="squareSideOut">—</span>
    </div>

    <div class="twoLine">
      <span class="label">Ø consigliato</span>
      <span class="value" id="circDNOut">—</span>
    </div>

    <div class="twoLine">
      <span class="label">Velocità Ø consigliato</span>
      <span class="value" id="circDNVOut">—</span>
    </div>

  </div>

</div>

<script>
function byId(i){return document.getElementById(i);}
function round(v,d){return Math.round(v*10**d)/10**d;}

const stdDiameters=[100,125,150,160,200,250,315,355,400,450,500,560,600];

const scenarios={
  res:{vMin:1.5,vMax:3.5},
  office:{vMin:2.0,vMax:4.0},
  hospital:{vMin:1.5,vMax:3.0},
  extract:{vMin:5.0,vMax:8.0},
  main:{vMin:6.0,vMax:9.0},
  none:{vMin:null,vMax:null}
};

(function(){
  const h=new Date().getHours();
  document.documentElement.setAttribute("data-theme",(h>=7 && h<19)?"light":"dark");
})();

byId("geom").addEventListener("change",()=>{
  const g=byId("geom").value;
  byId("rect_fields").style.display=(g==="rect")?"":"none";
  byId("circ_fields").style.display=(g==="circ")?"":"none";
  byId("rectOnly").style.display=(g==="rect")?"":"none";
  byId("circOut").style.display="none";
});

function getTag(v,min,max){
  if(min==null)return{text:"n/d",cls:"tag-na"};
  if(v<min)return{text:"Bassa",cls:"tag-low"};
  if(v<=max)return{text:"OK",cls:"tag-ok"};
  return{text:"Alta",cls:"tag-high"};
}

function calcola(){
  const Q=parseFloat(byId("flow").value);
  const V_in=parseFloat(byId("velocity").value);
  const geom=byId("geom").value;
  const scen=scenarios[byId("scenario").value];

  if(!Q||Q<=0){alert("Inserisci Q valida");return;}
  const Qs=Q/3600;

  let A=null,v=null;

  if(geom==="rect"){
    let b=parseFloat(byId("base").value)/1000;
    let h=parseFloat(byId("height").value)/1000;

    const hasB=!isNaN(b), hasH=!isNaN(h);

    if(V_in){
      A=Qs/V_in; v=V_in;
      if(hasB && !hasH){
        h=A/b; byId("height").value=round(h*1000,1);
      }
      else if(!hasB && hasH){
        b=A/h; byId("base").value=round(b*1000,1);
      }
      else if(!hasB && !hasH){
        const side=Math.sqrt(A)*1000;
        byId("stdDNOut").textContent="Lato "+round(side,1)+" mm";
      }
      else { A=b*h; v=Qs/A; }
    } else {
      if(!hasB || !hasH){ alert("Inserisci base e altezza se V è sconosciuta."); return; }
      A=b*h; v=Qs/A;
    }
  }

  if(geom==="circ"){
    const dMm=parseFloat(byId("diam").value);
    const hasD=dMm>0;

    if(V_in){ A=Qs/V_in; v=V_in; }
    else{
      if(!hasD){alert("Inserisci diametro se V mancante.");return;}
      const d=dMm/1000;
      A=Math.PI*d*d/4;
      v=Qs/A;
    }

    byId("circOut").style.display="";

    const side=Math.sqrt(A)*1000;
    byId("squareSideOut").textContent=round(side,1)+" mm";

    if(V_in && !hasD){
      const Deq=Math.sqrt(4*A/Math.PI)*1000;
      let best=null,min=9999;
      for(const dn of stdDiameters){
        if(Math.abs(dn-Deq)<min){ min=Math.abs(dn-Deq); best=dn; }
      }
      byId("circDNOut").textContent="Ø "+best+" mm";
      const Astd=Math.PI*(best/1000)**2/4;
      byId("circDNVOut").textContent=round(Qs/Astd,2)+" m/s";
    }
  }

  if(!A||!v){alert("Errore calcolo.");return;}

  byId("areaOut").textContent=round(A,4)+" m² ("+round(A*1e6,0)+" mm²)";
  byId("vEffOut").textContent=round(v,2)+" m/s";

  const tag=getTag(v,scen.vMin,scen.vMax);
  byId("vEffTag").textContent=tag.text;
  byId("vEffTag").className="tag "+tag.cls;

  if(geom==="rect"){
    const Deq=Math.sqrt(4*A/Math.PI)*1000;
    let best=null,min=9999;
    for(const dn of stdDiameters){
      if(Math.abs(dn-Deq)<min){ min=Math.abs(dn-Deq); best=dn; }
    }
    byId("stdDNOut").textContent="Ø "+best+" mm";
  }

  document.getElementById("results").scrollIntoView({behavior:"smooth"});
}
</script>

<!-- SERVICE WORKER REGISTRATION -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</div>
</body>
</html>
